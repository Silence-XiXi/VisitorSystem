# 邮件发送超时问题修复总结

## 问题描述
在批量发送20个邮件时，发送到11个左右就会卡住，出现以下错误：
- `缓存的传输器连接无效，将重新创建`
- `WARN [EmailService] 邮件发送失败，将重试（剩余0次）：tong.yun@wisesystemtech.com，原因：connect ETIMEDOUT 180.92.182.121:587`

## 根本原因分析
1. **SMTP连接超时**：网络连接不稳定导致ETIMEDOUT错误
2. **重试机制不当**：超时错误仍然进行重试，导致长时间卡住
3. **并发控制过强**：批次大小和并发数设置不合理
4. **连接池配置缺失**：没有启用连接池和连接复用

## 修复方案

### 1. 优化SMTP连接配置
```typescript
const transporterConfig: SMTPTransport.Options = {
  // 增加超时时间
  connectionTimeout: 60000, // 连接超时60秒
  greetingTimeout: 30000,   // 问候超时30秒
  socketTimeout: 60000,     // socket超时60秒
  
  // 添加连接池配置
  pool: true,               // 启用连接池
  maxConnections: 5,        // 最大连接数
  maxMessages: 100,         // 每个连接最大消息数
  rateLimit: 10,            // 每秒最大发送数
  
  // 添加重试配置
  retryDelay: 2000,         // 重试延迟2秒
  retryAttempts: 3,         // 重试次数
};
```

### 2. 优化队列服务配置
```typescript
private readonly MAX_CONCURRENT_JOBS = 2; // 减少并发任务数
private readonly BATCH_SIZE = 3; // 减少批次大小，提高稳定性
private readonly RETRY_DELAY = 3000; // 增加重试延迟到3秒
private readonly MAX_RETRIES = 2; // 减少重试次数，避免长时间卡住
private readonly BATCH_DELAY = 1000; // 批次间延迟1秒
```

### 3. 添加超时控制机制
```typescript
// 添加超时控制
const timeoutPromise = new Promise((_, reject) => {
  setTimeout(() => reject(new Error('邮件发送超时')), 30000); // 30秒超时
});

const sendPromise = this.emailService.sendWorkerQRCodeEmail(...);
const success = await Promise.race([sendPromise, timeoutPromise]) as boolean;
```

### 4. 优化重试逻辑
```typescript
// 排除超时错误的重试
if (retryCount < this.MAX_RETRIES && !errorMessage.includes('超时')) {
  // 进行重试
} else {
  // 直接标记为失败
}
```

### 5. 改进错误处理
- 添加详细的错误日志记录
- 区分不同类型的错误（超时、连接、认证等）
- 对超时错误不进行重试，直接标记为失败

## 修复效果

### 预期改进
1. **提高稳定性**：减少因网络问题导致的卡住现象
2. **加快处理速度**：优化并发控制和批次处理
3. **更好的错误处理**：超时错误不会无限重试
4. **连接复用**：使用连接池提高效率

### 配置参数说明
- **批次大小**：从5减少到3，降低单批次压力
- **并发任务**：从3减少到2，避免过载
- **重试次数**：从3减少到2，避免长时间卡住
- **超时时间**：增加到30秒，给网络更多时间
- **批次延迟**：1秒，避免服务器过载

## 使用建议

### 1. 监控邮件发送状态
- 查看后端日志了解发送进度
- 使用邮件历史功能查看失败记录

### 2. 网络环境优化
- 确保SMTP服务器连接稳定
- 考虑使用更可靠的邮件服务商

### 3. 批量发送策略
- 建议单次发送不超过50个邮件
- 大批量发送可以分批进行

## 测试验证
1. 重新启动后端服务
2. 尝试发送20个邮件
3. 观察是否还会卡住
4. 检查日志中的错误信息

## 后续优化建议
1. 添加邮件发送成功率统计
2. 实现邮件发送失败后的手动重发功能
3. 添加邮件发送队列的暂停/恢复功能
4. 考虑使用Redis队列进行更可靠的异步处理
