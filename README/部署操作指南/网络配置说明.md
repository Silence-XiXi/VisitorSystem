# ğŸŒ è®¿å®¢ç®¡ç†ç³»ç»Ÿç½‘ç»œé…ç½®è¯´æ˜

## ğŸ“‹ ç½‘ç»œåç§°

ç³»ç»Ÿä½¿ç”¨çš„ç½‘ç»œåç§°æ˜¯ï¼š**`visitorsystem-network`**ï¼ˆæ³¨æ„æœ‰ä¸¤ä¸ª `s`ï¼‰

## âš ï¸ é‡è¦å‘ç°ï¼šRedis è¿æ¥é…ç½®ä¸åŒ¹é…

### é—®é¢˜æè¿°

åœ¨ `start-containers.sh` è„šæœ¬ä¸­å­˜åœ¨é…ç½®ä¸åŒ¹é…çš„é—®é¢˜ï¼š

1. **Redis å®¹å™¨åç§°**ï¼š`visitor-redis`
2. **åç«¯ç¯å¢ƒå˜é‡**ï¼š`REDIS_HOST=redis`

è¿™å¯¼è‡´åç«¯å®¹å™¨æ— æ³•é€šè¿‡ `redis` ä¸»æœºåæ‰¾åˆ°å®é™…çš„ `visitor-redis` å®¹å™¨ã€‚

### è§£å†³æ–¹æ¡ˆ

æœ‰ä¸¤ç§æ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

---

## âœ… è§£å†³æ–¹æ¡ˆ1ï¼šåˆ›å»º Redis åˆ«åï¼ˆæ¨èï¼‰

ä¿®æ”¹ `start-containers.sh` è„šæœ¬ï¼Œä¸º Redis å®¹å™¨æ·»åŠ  `redis` åˆ«åï¼š

```bash
# ä¿®æ”¹ Redis å¯åŠ¨å‘½ä»¤ï¼ˆåœ¨ç¬¬77-82è¡Œï¼‰
docker run -d \
  --name visitor-redis \
  --network visitorsystem-network \
  --network-alias redis \  # æ·»åŠ è¿™ä¸€è¡Œ
  -p 6379:6379 \
  -v redis_data:/data \
  redis:7-alpine redis-server --appendonly yes --requirepass redis123
```

æˆ–è€…ä½¿ç”¨ Docker Composeï¼ˆæ›´æ¨èï¼‰ï¼š

```bash
# ä½¿ç”¨ Docker Compose ä¼šè‡ªåŠ¨å¤„ç†æœåŠ¡åç§°å’Œåˆ«å
docker compose -f docker-compose.base.yml -f docker-compose.blue.yml -f docker-compose.nginx.yml up -d
```

---

## âœ… è§£å†³æ–¹æ¡ˆ2ï¼šä¿®æ”¹ç¯å¢ƒå˜é‡

å¦‚æœä½¿ç”¨ `start-containers.sh` è„šæœ¬ï¼Œä¿®æ”¹åç«¯å®¹å™¨çš„ç¯å¢ƒå˜é‡ï¼š

```bash
# åœ¨ç¬¬132-149è¡Œï¼Œä¿®æ”¹ç¯å¢ƒå˜é‡
-e REDIS_HOST=visitor-redis \  # æ”¹ä¸ºå®¹å™¨å
-e REDIS_URL=redis://:redis123@visitor-redis:6379 \  # æ”¹ä¸ºå®¹å™¨å
```

---

## ğŸ“Š å®Œæ•´ç½‘ç»œé…ç½®æ±‡æ€»

### Docker Compose æ–¹å¼ï¼ˆæ¨èï¼‰

ç½‘ç»œåç§°ï¼š`visitorsystem-network`

```yaml
# docker-compose.base.yml
networks:
  visitorsystem-network:
    external: true
```

**å®¹å™¨ç½‘ç»œæ˜ å°„**ï¼š

| æœåŠ¡ç±»å‹ | Compose æœåŠ¡å | å®¹å™¨å | ä¸»æœºåç”¨äºè¿æ¥ |
|---------|---------------|--------|---------------|
| PostgreSQL | `postgres` | `visitor-postgres` | `postgres` âœ… |
| Redis | `redis` | `visitor-redis` | `redis` âœ… |
| Adminer | `adminer` | `visitor-adminer` | `adminer` âœ… |
| åç«¯è“ | `backend-blue` | `visitor-backend-blue` | `backend-blue` âœ… |
| å‰ç«¯è“ | `frontend-blue` | `visitor-frontend-blue` | `frontend-blue` âœ… |
| Nginx | `nginx` | `visitor-nginx` | `nginx` âœ… |

**æ³¨æ„**ï¼šä½¿ç”¨ Docker Compose æ—¶ï¼ŒæœåŠ¡ä¹‹é—´ä½¿ç”¨**æœåŠ¡åï¼ˆservice nameï¼‰**è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸æ˜¯å®¹å™¨åã€‚

### è„šæœ¬æ–¹å¼ï¼ˆstart-containers.shï¼‰

ç½‘ç»œåç§°ï¼š`visitorsystem-network`

**å®¹å™¨åˆ—è¡¨**ï¼š

| å®¹å™¨å | ä¸»æœºåå¼•ç”¨ | é—®é¢˜ |
|-------|-----------|------|
| `visitor-postgres` | `postgres` | âœ… æ­£ç¡® |
| `visitor-redis` | `redis` | âŒ ä¸åŒ¹é…ï¼ |
| `visitor-adminer` | `adminer` | âœ… æ­£ç¡® |
| `visitor-backend-blue` | - | - |
| `visitor-frontend-blue` | - | - |
| `visitor-nginx` | - | - |

**æ³¨æ„**ï¼šä½¿ç”¨çº¯ Docker å‘½ä»¤æ—¶ï¼Œéœ€è¦ä½¿ç”¨**å®¹å™¨å**æˆ–**ç½‘ç»œåˆ«å**è¿›è¡Œé€šä¿¡ã€‚

---

## ğŸ”§ æ¨èä¿®å¤æ­¥éª¤

### æ–¹æ³•1ï¼šä½¿ç”¨ Docker Composeï¼ˆæœ€ç®€å•ï¼‰

```bash
# 1. åœæ­¢æ‰‹åŠ¨åˆ›å»ºçš„å®¹å™¨
docker stop visitor-backend-blue visitor-frontend-blue visitor-nginx visitor-postgres visitor-redis visitor-adminer
docker rm visitor-backend-blue visitor-frontend-blue visitor-nginx visitor-postgres visitor-redis visitor-adminer

# 2. åˆ›å»ºç½‘ç»œ
docker network create visitorsystem-network

# 3. ä½¿ç”¨ Docker Compose å¯åŠ¨ï¼ˆè‡ªåŠ¨å¤„ç†ç½‘ç»œå’ŒæœåŠ¡åï¼‰
docker compose -f docker-compose.base.yml -f docker-compose.blue.yml -f docker-compose.nginx.yml up -d --build

# 4. éªŒè¯
docker ps
curl http://localhost:8086/api/health
```

### æ–¹æ³•2ï¼šä¿®å¤ start-containers.sh è„šæœ¬

```bash
# ç¼–è¾‘ start-containers.sh
vim start-containers.sh

# æ‰¾åˆ°ç¬¬138-141è¡Œï¼Œä¿®æ”¹ä¸ºï¼š
-e REDIS_HOST=visitor-redis \
-e REDIS_PORT=6379 \
-e REDIS_PASSWORD=redis123 \
-e REDIS_URL=redis://:redis123@visitor-redis:6379 \

# æˆ–è€…æ·»åŠ ç½‘ç»œåˆ«åï¼ˆç¬¬77-82è¡Œï¼‰ï¼š
docker run -d \
  --name visitor-redis \
  --network visitorsystem-network \
  --network-alias redis \  # æ·»åŠ è¿™ä¸€è¡Œ
  -p 6379:6379 \
  redis:7-alpine redis-server --requirepass redis123
```

---

## ğŸ“ æ£€æŸ¥ç½‘ç»œé…ç½®çš„å‘½ä»¤

```bash
# 1. åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ
docker network ls

# 2. æŸ¥çœ‹ visitorsystem-network è¯¦æƒ…
docker network inspect visitorsystem-network

# 3. æŸ¥çœ‹ç½‘ç»œä¸­çš„å®¹å™¨
docker network inspect visitorsystem-network | grep -A 5 "visitor"

# 4. æµ‹è¯• DNS è§£æ
docker exec visitor-backend-blue nslookup redis
docker exec visitor-backend-blue nslookup visitor-redis

# 5. æµ‹è¯• Redis è¿æ¥
docker exec visitor-backend-blue sh -c "nc -zv redis 6379"
docker exec visitor-backend-blue sh -c "nc -zv visitor-redis 6379"
```

---

## ğŸ¯ æœ€ä½³å®è·µå»ºè®®

### æ¨èä½¿ç”¨ Docker Compose

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨å¤„ç†ç½‘ç»œå’ŒæœåŠ¡å
- âœ… é…ç½®ç»Ÿä¸€ç®¡ç†
- âœ… æ”¯æŒè“ç»¿éƒ¨ç½²
- âœ… æ›´å®¹æ˜“ç»´æŠ¤

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
# å¯åŠ¨åŸºç¡€æœåŠ¡
docker compose -f docker-compose.base.yml up -d

# å¯åŠ¨è“ç¯å¢ƒ
docker compose -f docker-compose.base.yml -f docker-compose.blue.yml -f docker-compose.nginx.yml up -d --build

# å¯åŠ¨ç»¿ç¯å¢ƒï¼ˆé›¶åœæœºï¼‰
docker compose -f docker-compose.base.yml -f docker-compose.green.yml up -d --build

# åˆ‡æ¢åˆ°ç»¿ç¯å¢ƒ
./switch-nginx-env.sh green
```

### é¿å…æ··ç”¨æ–¹å¼

âŒ **ä¸è¦åŒæ—¶ä½¿ç”¨** Docker Compose å’Œæ‰‹åŠ¨ `docker run` å‘½ä»¤

åŸå› ï¼š
- å®¹å™¨å‘½åä¸ä¸€è‡´
- ç½‘ç»œé…ç½®æ··ä¹±
- ç¯å¢ƒå˜é‡ä¸åŒ¹é…

---

## ğŸ” å½“å‰ç³»ç»ŸçŠ¶æ€æ£€æŸ¥

```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨
docker ps -a | grep visitor

# æ£€æŸ¥ç½‘ç»œ
docker network ls | grep visitorsystem

# æ£€æŸ¥å®¹å™¨æ‰€å±ç½‘ç»œ
docker inspect visitor-backend-blue | grep -A 20 "Networks"
docker inspect visitor-redis | grep -A 20 "Networks"

# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker inspect visitor-backend-blue | grep -A 5 "REDIS_HOST"
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- `docker-compose.base.yml` - åŸºç¡€æœåŠ¡é…ç½®
- `docker-compose.blue.yml` - è“ç¯å¢ƒé…ç½®
- `docker-compose.green.yml` - ç»¿ç¯å¢ƒé…ç½®
- `docker-compose.nginx.yml` - Nginx é…ç½®
- `start-containers.sh` - æ‰‹åŠ¨å¯åŠ¨è„šæœ¬

---

**æ€»ç»“ï¼šç³»ç»Ÿç½‘ç»œåç§°æ˜¯ `visitorsystem-network`ï¼Œæ¨èä½¿ç”¨ Docker Compose æ–¹å¼éƒ¨ç½²ï¼** âœ…

