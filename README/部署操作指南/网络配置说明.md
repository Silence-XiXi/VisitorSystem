# 🌐 访客管理系统网络配置说明

## 📋 网络名称

系统使用的网络名称是：**`visitorsystem-network`**（注意有两个 `s`）

## ⚠️ 重要发现：Redis 连接配置不匹配

### 问题描述

在 `start-containers.sh` 脚本中存在配置不匹配的问题：

1. **Redis 容器名称**：`visitor-redis`
2. **后端环境变量**：`REDIS_HOST=redis`

这导致后端容器无法通过 `redis` 主机名找到实际的 `visitor-redis` 容器。

### 解决方案

有两种方法解决这个问题：

---

## ✅ 解决方案1：创建 Redis 别名（推荐）

修改 `start-containers.sh` 脚本，为 Redis 容器添加 `redis` 别名：

```bash
# 修改 Redis 启动命令（在第77-82行）
docker run -d \
  --name visitor-redis \
  --network visitorsystem-network \
  --network-alias redis \  # 添加这一行
  -p 6379:6379 \
  -v redis_data:/data \
  redis:7-alpine redis-server --appendonly yes --requirepass redis123
```

或者使用 Docker Compose（更推荐）：

```bash
# 使用 Docker Compose 会自动处理服务名称和别名
docker compose -f docker-compose.base.yml -f docker-compose.blue.yml -f docker-compose.nginx.yml up -d
```

---

## ✅ 解决方案2：修改环境变量

如果使用 `start-containers.sh` 脚本，修改后端容器的环境变量：

```bash
# 在第132-149行，修改环境变量
-e REDIS_HOST=visitor-redis \  # 改为容器名
-e REDIS_URL=redis://:redis123@visitor-redis:6379 \  # 改为容器名
```

---

## 📊 完整网络配置汇总

### Docker Compose 方式（推荐）

网络名称：`visitorsystem-network`

```yaml
# docker-compose.base.yml
networks:
  visitorsystem-network:
    external: true
```

**容器网络映射**：

| 服务类型 | Compose 服务名 | 容器名 | 主机名用于连接 |
|---------|---------------|--------|---------------|
| PostgreSQL | `postgres` | `visitor-postgres` | `postgres` ✅ |
| Redis | `redis` | `visitor-redis` | `redis` ✅ |
| Adminer | `adminer` | `visitor-adminer` | `adminer` ✅ |
| 后端蓝 | `backend-blue` | `visitor-backend-blue` | `backend-blue` ✅ |
| 前端蓝 | `frontend-blue` | `visitor-frontend-blue` | `frontend-blue` ✅ |
| Nginx | `nginx` | `visitor-nginx` | `nginx` ✅ |

**注意**：使用 Docker Compose 时，服务之间使用**服务名（service name）**进行通信，而不是容器名。

### 脚本方式（start-containers.sh）

网络名称：`visitorsystem-network`

**容器列表**：

| 容器名 | 主机名引用 | 问题 |
|-------|-----------|------|
| `visitor-postgres` | `postgres` | ✅ 正确 |
| `visitor-redis` | `redis` | ❌ 不匹配！ |
| `visitor-adminer` | `adminer` | ✅ 正确 |
| `visitor-backend-blue` | - | - |
| `visitor-frontend-blue` | - | - |
| `visitor-nginx` | - | - |

**注意**：使用纯 Docker 命令时，需要使用**容器名**或**网络别名**进行通信。

---

## 🔧 推荐修复步骤

### 方法1：使用 Docker Compose（最简单）

```bash
# 1. 停止手动创建的容器
docker stop visitor-backend-blue visitor-frontend-blue visitor-nginx visitor-postgres visitor-redis visitor-adminer
docker rm visitor-backend-blue visitor-frontend-blue visitor-nginx visitor-postgres visitor-redis visitor-adminer

# 2. 创建网络
docker network create visitorsystem-network

# 3. 使用 Docker Compose 启动（自动处理网络和服务名）
docker compose -f docker-compose.base.yml -f docker-compose.blue.yml -f docker-compose.nginx.yml up -d --build

# 4. 验证
docker ps
curl http://localhost:8086/api/health
```

### 方法2：修复 start-containers.sh 脚本

```bash
# 编辑 start-containers.sh
vim start-containers.sh

# 找到第138-141行，修改为：
-e REDIS_HOST=visitor-redis \
-e REDIS_PORT=6379 \
-e REDIS_PASSWORD=redis123 \
-e REDIS_URL=redis://:redis123@visitor-redis:6379 \

# 或者添加网络别名（第77-82行）：
docker run -d \
  --name visitor-redis \
  --network visitorsystem-network \
  --network-alias redis \  # 添加这一行
  -p 6379:6379 \
  redis:7-alpine redis-server --requirepass redis123
```

---

## 📝 检查网络配置的命令

```bash
# 1. 列出所有网络
docker network ls

# 2. 查看 visitorsystem-network 详情
docker network inspect visitorsystem-network

# 3. 查看网络中的容器
docker network inspect visitorsystem-network | grep -A 5 "visitor"

# 4. 测试 DNS 解析
docker exec visitor-backend-blue nslookup redis
docker exec visitor-backend-blue nslookup visitor-redis

# 5. 测试 Redis 连接
docker exec visitor-backend-blue sh -c "nc -zv redis 6379"
docker exec visitor-backend-blue sh -c "nc -zv visitor-redis 6379"
```

---

## 🎯 最佳实践建议

### 推荐使用 Docker Compose

**优势**：
- ✅ 自动处理网络和服务名
- ✅ 配置统一管理
- ✅ 支持蓝绿部署
- ✅ 更容易维护

**使用方法**：
```bash
# 启动基础服务
docker compose -f docker-compose.base.yml up -d

# 启动蓝环境
docker compose -f docker-compose.base.yml -f docker-compose.blue.yml -f docker-compose.nginx.yml up -d --build

# 启动绿环境（零停机）
docker compose -f docker-compose.base.yml -f docker-compose.green.yml up -d --build

# 切换到绿环境
./switch-nginx-env.sh green
```

### 避免混用方式

❌ **不要同时使用** Docker Compose 和手动 `docker run` 命令

原因：
- 容器命名不一致
- 网络配置混乱
- 环境变量不匹配

---

## 🔍 当前系统状态检查

```bash
# 检查所有容器
docker ps -a | grep visitor

# 检查网络
docker network ls | grep visitorsystem

# 检查容器所属网络
docker inspect visitor-backend-blue | grep -A 20 "Networks"
docker inspect visitor-redis | grep -A 20 "Networks"

# 检查环境变量
docker inspect visitor-backend-blue | grep -A 5 "REDIS_HOST"
```

---

## 📚 参考资料

- `docker-compose.base.yml` - 基础服务配置
- `docker-compose.blue.yml` - 蓝环境配置
- `docker-compose.green.yml` - 绿环境配置
- `docker-compose.nginx.yml` - Nginx 配置
- `start-containers.sh` - 手动启动脚本

---

**总结：系统网络名称是 `visitorsystem-network`，推荐使用 Docker Compose 方式部署！** ✅

