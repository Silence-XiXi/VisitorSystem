# 🗄️ 数据库迁移执行步骤

## 📋 前提条件

- ✅ Docker 已安装并运行
- ✅ 基础服务容器已启动（PostgreSQL, Redis）
- ✅ 后端容器已创建（即使未运行也可以）

---

## 🚀 快速执行（推荐）

### 方法1: 使用自动化脚本（最简单）

```bash
# 1. 确保有执行权限
chmod +x migrate-database.sh

# 2. 执行数据库迁移
./migrate-database.sh
```

脚本会自动：
1. ✅ 检查数据库连接
2. ✅ 检查后端容器
3. ✅ 执行数据库迁移
4. ✅ 生成 Prisma 客户端
5. ✅ 执行种子数据
6. ✅ 验证迁移结果
7. ✅ 重启后端服务

---

## 🔧 手动执行步骤

如果自动化脚本失败，可以手动逐步执行：

### 步骤1: 检查容器状态

```bash
# 检查数据库容器
docker ps | grep visitor-postgres

# 检查后端容器（可能未运行）
docker ps -a | grep visitor-backend-blue
```

### 步骤2: 启动基础服务（如果未运行）

```bash
# 创建网络（如果不存在）
docker network create visitorsystem-network

# 启动数据库（如果未运行）
docker run -d \
  --name visitor-postgres \
  --network visitorsystem-network \
  -p 5432:5432 \
  -e POSTGRES_DB=visitor_system \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres123 \
  -v visitor_postgres_data:/var/lib/postgresql/data \
  postgres:15-alpine

# 启动Redis（如果未运行）
docker run -d \
  --name visitor-redis \
  --network visitorsystem-network \
  -p 6379:6379 \
  -e REDIS_PASSWORD=redis123 \
  redis:7-alpine redis-server --requirepass redis123
```

### 步骤3: 启动后端容器

```bash
# 如果后端容器未启动，先启动它
docker start visitor-backend-blue

# 或者创建并启动（如果容器不存在）
docker run -d \
  --name visitor-backend-blue \
  --network visitorsystem-network \
  -p 3001:3000 \
  -e NODE_ENV=production \
  -e DATABASE_URL=postgresql://postgres:postgres123@postgres:5432/visitor_system \
  -e REDIS_HOST=redis \
  -e REDIS_PORT=6379 \
  -e REDIS_PASSWORD=redis123 \
  -e REDIS_URL=redis://:redis123@redis:6379 \
  -e JWT_SECRET=19391a718294795aa6a61a3e9eb837b9644888c0c35ffbe70cea1a57fc097c16 \
  -e EMAIL_HOST=mail.wisesystemtech.com \
  -e EMAIL_PORT=587 \
  -e EMAIL_USER=erpsystem@wisesystemtech.com \
  -e EMAIL_PASSWORD=jv7VSByIRIl2lhM5 \
  -e WHATSAPP_API_KEY=1e673379256fe1b0385c97d8120fbb30 \
  -e WHATSAPP_PHONE_NUMBER=+85261606103 \
  visitor-backend-blue
```

### 步骤4: 执行数据库迁移

```bash
# 方式A: 在后端容器内执行（推荐）
docker exec visitor-backend-blue sh -c "cd /app && npx prisma migrate deploy"
```

**预期输出：**
```
Running migrations:
  - 20250911034134_init
  - 20250911082206_add_return_handler
  - 20250912092645_add_distributor_id
  - ... (更多迁移)
Applying migration `xxx`
✓ Applied `xxx`
✓ Prisma migrations executed successfully.
```

如果容器内执行失败，使用方式B：

```bash
# 方式B: 在宿主机执行（需要先安装Node.js和依赖）
cd visitorSystem-backend
export DATABASE_URL="postgresql://postgres:postgres123@localhost:5432/visitor_system"
npx prisma migrate deploy
cd ..
```

### 步骤5: 生成Prisma客户端

```bash
# 在后端容器内生成
docker exec visitor-backend-blue sh -c "cd /app && npx prisma generate"
```

**如果遇到权限问题：**

```bash
# 使用root权限执行
docker exec --user root visitor-backend-blue sh -c "cd /app && npx prisma generate"
```

### 步骤6: 执行种子数据

```bash
# 方式1: 使用 ts-node（推荐）
docker exec visitor-backend-blue sh -c "cd /app && npx ts-node --esm prisma/seed.ts"

# 方式2: 使用 tsx（如果ts-node失败）
docker exec visitor-backend-blue sh -c "cd /app && npx tsx prisma/seed.ts"

# 方式3: 使用 Prisma 的 db seed 命令
docker exec visitor-backend-blue sh -c "cd /app && npx prisma db seed"
```

**预期输出：**
```
开始创建测试数据...
✓ 管理员用户创建成功
✓ 分判商创建成功
✓ 工地创建成功
✓ 分判商-工地关联创建成功
✓ 门卫创建成功
✓ 工人创建成功
✓ 物品分类创建成功
✓ 物品创建成功
✓ 借用记录创建成功
✓ 访客记录创建成功

🎉 数据库种子数据创建完成！
```

### 步骤7: 验证迁移结果

```bash
# 查看数据库表
docker exec visitor-postgres psql -U postgres -d visitor_system -c "\dt"

# 查看迁移历史
docker exec visitor-postgres psql -U postgres -d visitor_system -c "SELECT migration_name, finished_at FROM _prisma_migrations ORDER BY finished_at DESC LIMIT 10;"
```

### 步骤8: 重启后端服务

```bash
# 重启后端容器
docker restart visitor-backend-blue

# 等待10秒
sleep 10

# 检查容器状态
docker ps | grep visitor-backend-blue
```

### 步骤9: 验证后端服务

```bash
# 查看后端日志
docker logs visitor-backend-blue

# 测试健康检查
curl http://localhost:3001/api/health

# 预期输出: {"status":"ok"}
```

---

## 🔍 故障排查

### 问题1: 容器未运行

```bash
# 查看容器状态
docker ps -a | grep visitor-backend-blue

# 查看容器日志
docker logs visitor-backend-blue

# 重启容器
docker start visitor-backend-blue
```

### 问题2: 数据库连接失败

```bash
# 检查数据库容器
docker ps | grep visitor-postgres

# 测试数据库连接
docker exec visitor-postgres psql -U postgres -c "SELECT 1;"

# 如果连接失败，重启数据库容器
docker restart visitor-postgres
```

### 问题3: 迁移失败

```bash
# 查看详细错误
docker exec visitor-backend-blue sh -c "cd /app && npx prisma migrate deploy" --verbose

# 手动重置迁移（⚠️ 危险操作，会丢失数据）
docker exec visitor-postgres psql -U postgres -d visitor_system -c "DELETE FROM _prisma_migrations;"

# 重新执行迁移
docker exec visitor-backend-blue sh -c "cd /app && npx prisma migrate deploy"
```

### 问题4: 种子数据执行失败

```bash
# 检查数据库是否已有数据
docker exec visitor-postgres psql -U postgres -d visitor_system -c "SELECT COUNT(*) FROM users;"

# 如果已有数据，可跳过种子数据
# 直接重启后端服务
docker restart visitor-backend-blue
```

### 问题5: 权限问题

```bash
# 如果遇到权限问题，使用root权限
docker exec --user root visitor-backend-blue sh -c "cd /app && npx prisma generate"
docker exec --user root visitor-backend-blue sh -c "cd /app && npx ts-node --esm prisma/seed.ts"
```

---

## 📊 验证成功标志

数据库迁移成功后，应该看到：

1. ✅ 后端容器正常运行
   ```bash
   docker ps | grep visitor-backend-blue
   # 应该显示: Up X minutes
   ```

2. ✅ 健康检查通过
   ```bash
   curl http://localhost:3001/api/health
   # 返回: {"status":"ok"}
   ```

3. ✅ 数据库表已创建
   ```bash
   docker exec visitor-postgres psql -U postgres -d visitor_system -c "\dt"
   # 应该看到所有表
   ```

4. ✅ 有测试用户数据
   ```bash
   docker exec visitor-postgres psql -U postgres -d visitor_system -c "SELECT username, role FROM users;"
   # 应该看到 admin, bjadmin, guard001 等用户
   ```

---

## 🎯 使用默认账号登录

迁移成功后，可以使用以下账号登录系统：

| 角色 | 用户名 | 密码 | 说明 |
|------|--------|------|------|
| 管理员 | `admin` | `admin123` | 系统管理员 |
| 分判商 | `bjadmin` | `dist123` | 北京建筑公司 |
| 分判商 | `shadmin` | `dist123` | 上海工程集团 |
| 分判商 | `gzadmin` | `dist123` | 广州建设有限公司 |
| 门卫 | `guard001` | `guard123` | 张保安 |
| 门卫 | `guard002` | `guard123` | 李门卫 |
| 门卫 | `guard003` | `guard123` | 王警卫 |

访问地址：`http://服务器IP` 或 `http://服务器IP:8086`

---

## 🔄 完整执行命令总结

```bash
# 一次性执行所有步骤
./migrate-database.sh

# 如果脚本失败，手动执行：
docker exec visitor-backend-blue sh -c "cd /app && npx prisma migrate deploy"
docker exec --user root visitor-backend-blue sh -c "cd /app && npx prisma generate"
docker exec visitor-backend-blue sh -c "cd /app && npx ts-node --esm prisma/seed.ts"
docker restart visitor-backend-blue

# 验证
docker ps | grep visitor
curl http://localhost:3001/api/health
```

---

## 📝 注意事项

1. ⚠️ **数据安全**: 迁移前建议备份数据库
   ```bash
   docker exec visitor-postgres pg_dump -U postgres visitor_system > backup_$(date +%Y%m%d).sql
   ```

2. ⚠️ **网络配置**: 确保容器在同一个网络中
   ```bash
   docker network inspect visitorsystem-network
   ```

3. ⚠️ **环境变量**: 检查环境变量配置是否正确
   ```bash
   docker exec visitor-backend-blue env | grep DATABASE_URL
   docker exec visitor-backend-blue env | grep REDIS_URL
   ```

4. ⚠️ **端口冲突**: 确保端口未被占用
   ```bash
   netstat -tulpn | grep :3001
   netstat -tulpn | grep :5432
   ```

---

**迁移成功后，后端服务应该会自动启动！🎉**

