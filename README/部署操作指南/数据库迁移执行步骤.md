# ğŸ—„ï¸ æ•°æ®åº“è¿ç§»æ‰§è¡Œæ­¥éª¤

## ğŸ“‹ å‰ææ¡ä»¶

- âœ… Docker å·²å®‰è£…å¹¶è¿è¡Œ
- âœ… åŸºç¡€æœåŠ¡å®¹å™¨å·²å¯åŠ¨ï¼ˆPostgreSQL, Redisï¼‰
- âœ… åç«¯å®¹å™¨å·²åˆ›å»ºï¼ˆå³ä½¿æœªè¿è¡Œä¹Ÿå¯ä»¥ï¼‰

---

## ğŸš€ å¿«é€Ÿæ‰§è¡Œï¼ˆæ¨èï¼‰

### æ–¹æ³•1: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬ï¼ˆæœ€ç®€å•ï¼‰

```bash
# 1. ç¡®ä¿æœ‰æ‰§è¡Œæƒé™
chmod +x migrate-database.sh

# 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»
./migrate-database.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. âœ… æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. âœ… æ£€æŸ¥åç«¯å®¹å™¨
3. âœ… æ‰§è¡Œæ•°æ®åº“è¿ç§»
4. âœ… ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
5. âœ… æ‰§è¡Œç§å­æ•°æ®
6. âœ… éªŒè¯è¿ç§»ç»“æœ
7. âœ… é‡å¯åç«¯æœåŠ¡

---

## ğŸ”§ æ‰‹åŠ¨æ‰§è¡Œæ­¥éª¤

å¦‚æœè‡ªåŠ¨åŒ–è„šæœ¬å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨é€æ­¥æ‰§è¡Œï¼š

### æ­¥éª¤1: æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
# æ£€æŸ¥æ•°æ®åº“å®¹å™¨
docker ps | grep visitor-postgres

# æ£€æŸ¥åç«¯å®¹å™¨ï¼ˆå¯èƒ½æœªè¿è¡Œï¼‰
docker ps -a | grep visitor-backend-blue
```

### æ­¥éª¤2: å¯åŠ¨åŸºç¡€æœåŠ¡ï¼ˆå¦‚æœæœªè¿è¡Œï¼‰

```bash
# åˆ›å»ºç½‘ç»œï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
docker network create visitorsystem-network

# å¯åŠ¨æ•°æ®åº“ï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
docker run -d \
  --name visitor-postgres \
  --network visitorsystem-network \
  -p 5432:5432 \
  -e POSTGRES_DB=visitor_system \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres123 \
  -v visitor_postgres_data:/var/lib/postgresql/data \
  postgres:15-alpine

# å¯åŠ¨Redisï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
docker run -d \
  --name visitor-redis \
  --network visitorsystem-network \
  -p 6379:6379 \
  -e REDIS_PASSWORD=redis123 \
  redis:7-alpine redis-server --requirepass redis123
```

### æ­¥éª¤3: å¯åŠ¨åç«¯å®¹å™¨

```bash
# å¦‚æœåç«¯å®¹å™¨æœªå¯åŠ¨ï¼Œå…ˆå¯åŠ¨å®ƒ
docker start visitor-backend-blue

# æˆ–è€…åˆ›å»ºå¹¶å¯åŠ¨ï¼ˆå¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼‰
docker run -d \
  --name visitor-backend-blue \
  --network visitorsystem-network \
  -p 3001:3000 \
  -e NODE_ENV=production \
  -e DATABASE_URL=postgresql://postgres:postgres123@postgres:5432/visitor_system \
  -e REDIS_HOST=redis \
  -e REDIS_PORT=6379 \
  -e REDIS_PASSWORD=redis123 \
  -e REDIS_URL=redis://:redis123@redis:6379 \
  -e JWT_SECRET=19391a718294795aa6a61a3e9eb837b9644888c0c35ffbe70cea1a57fc097c16 \
  -e EMAIL_HOST=mail.wisesystemtech.com \
  -e EMAIL_PORT=587 \
  -e EMAIL_USER=erpsystem@wisesystemtech.com \
  -e EMAIL_PASSWORD=jv7VSByIRIl2lhM5 \
  -e WHATSAPP_API_KEY=1e673379256fe1b0385c97d8120fbb30 \
  -e WHATSAPP_PHONE_NUMBER=+85261606103 \
  visitor-backend-blue
```

### æ­¥éª¤4: æ‰§è¡Œæ•°æ®åº“è¿ç§»

```bash
# æ–¹å¼A: åœ¨åç«¯å®¹å™¨å†…æ‰§è¡Œï¼ˆæ¨èï¼‰
docker exec visitor-backend-blue sh -c "cd /app && npx prisma migrate deploy"
```

**é¢„æœŸè¾“å‡ºï¼š**
```
Running migrations:
  - 20250911034134_init
  - 20250911082206_add_return_handler
  - 20250912092645_add_distributor_id
  - ... (æ›´å¤šè¿ç§»)
Applying migration `xxx`
âœ“ Applied `xxx`
âœ“ Prisma migrations executed successfully.
```

å¦‚æœå®¹å™¨å†…æ‰§è¡Œå¤±è´¥ï¼Œä½¿ç”¨æ–¹å¼Bï¼š

```bash
# æ–¹å¼B: åœ¨å®¿ä¸»æœºæ‰§è¡Œï¼ˆéœ€è¦å…ˆå®‰è£…Node.jså’Œä¾èµ–ï¼‰
cd visitorSystem-backend
export DATABASE_URL="postgresql://postgres:postgres123@localhost:5432/visitor_system"
npx prisma migrate deploy
cd ..
```

### æ­¥éª¤5: ç”ŸæˆPrismaå®¢æˆ·ç«¯

```bash
# åœ¨åç«¯å®¹å™¨å†…ç”Ÿæˆ
docker exec visitor-backend-blue sh -c "cd /app && npx prisma generate"
```

**å¦‚æœé‡åˆ°æƒé™é—®é¢˜ï¼š**

```bash
# ä½¿ç”¨rootæƒé™æ‰§è¡Œ
docker exec --user root visitor-backend-blue sh -c "cd /app && npx prisma generate"
```

### æ­¥éª¤6: æ‰§è¡Œç§å­æ•°æ®

```bash
# æ–¹å¼1: ä½¿ç”¨ ts-nodeï¼ˆæ¨èï¼‰
docker exec visitor-backend-blue sh -c "cd /app && npx ts-node --esm prisma/seed.ts"

# æ–¹å¼2: ä½¿ç”¨ tsxï¼ˆå¦‚æœts-nodeå¤±è´¥ï¼‰
docker exec visitor-backend-blue sh -c "cd /app && npx tsx prisma/seed.ts"

# æ–¹å¼3: ä½¿ç”¨ Prisma çš„ db seed å‘½ä»¤
docker exec visitor-backend-blue sh -c "cd /app && npx prisma db seed"
```

**é¢„æœŸè¾“å‡ºï¼š**
```
å¼€å§‹åˆ›å»ºæµ‹è¯•æ•°æ®...
âœ“ ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºæˆåŠŸ
âœ“ åˆ†åˆ¤å•†åˆ›å»ºæˆåŠŸ
âœ“ å·¥åœ°åˆ›å»ºæˆåŠŸ
âœ“ åˆ†åˆ¤å•†-å·¥åœ°å…³è”åˆ›å»ºæˆåŠŸ
âœ“ é—¨å«åˆ›å»ºæˆåŠŸ
âœ“ å·¥äººåˆ›å»ºæˆåŠŸ
âœ“ ç‰©å“åˆ†ç±»åˆ›å»ºæˆåŠŸ
âœ“ ç‰©å“åˆ›å»ºæˆåŠŸ
âœ“ å€Ÿç”¨è®°å½•åˆ›å»ºæˆåŠŸ
âœ“ è®¿å®¢è®°å½•åˆ›å»ºæˆåŠŸ

ğŸ‰ æ•°æ®åº“ç§å­æ•°æ®åˆ›å»ºå®Œæˆï¼
```

### æ­¥éª¤7: éªŒè¯è¿ç§»ç»“æœ

```bash
# æŸ¥çœ‹æ•°æ®åº“è¡¨
docker exec visitor-postgres psql -U postgres -d visitor_system -c "\dt"

# æŸ¥çœ‹è¿ç§»å†å²
docker exec visitor-postgres psql -U postgres -d visitor_system -c "SELECT migration_name, finished_at FROM _prisma_migrations ORDER BY finished_at DESC LIMIT 10;"
```

### æ­¥éª¤8: é‡å¯åç«¯æœåŠ¡

```bash
# é‡å¯åç«¯å®¹å™¨
docker restart visitor-backend-blue

# ç­‰å¾…10ç§’
sleep 10

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep visitor-backend-blue
```

### æ­¥éª¤9: éªŒè¯åç«¯æœåŠ¡

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
docker logs visitor-backend-blue

# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:3001/api/health

# é¢„æœŸè¾“å‡º: {"status":"ok"}
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: å®¹å™¨æœªè¿è¡Œ

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker ps -a | grep visitor-backend-blue

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs visitor-backend-blue

# é‡å¯å®¹å™¨
docker start visitor-backend-blue
```

### é—®é¢˜2: æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥æ•°æ®åº“å®¹å™¨
docker ps | grep visitor-postgres

# æµ‹è¯•æ•°æ®åº“è¿æ¥
docker exec visitor-postgres psql -U postgres -c "SELECT 1;"

# å¦‚æœè¿æ¥å¤±è´¥ï¼Œé‡å¯æ•°æ®åº“å®¹å™¨
docker restart visitor-postgres
```

### é—®é¢˜3: è¿ç§»å¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
docker exec visitor-backend-blue sh -c "cd /app && npx prisma migrate deploy" --verbose

# æ‰‹åŠ¨é‡ç½®è¿ç§»ï¼ˆâš ï¸ å±é™©æ“ä½œï¼Œä¼šä¸¢å¤±æ•°æ®ï¼‰
docker exec visitor-postgres psql -U postgres -d visitor_system -c "DELETE FROM _prisma_migrations;"

# é‡æ–°æ‰§è¡Œè¿ç§»
docker exec visitor-backend-blue sh -c "cd /app && npx prisma migrate deploy"
```

### é—®é¢˜4: ç§å­æ•°æ®æ‰§è¡Œå¤±è´¥

```bash
# æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²æœ‰æ•°æ®
docker exec visitor-postgres psql -U postgres -d visitor_system -c "SELECT COUNT(*) FROM users;"

# å¦‚æœå·²æœ‰æ•°æ®ï¼Œå¯è·³è¿‡ç§å­æ•°æ®
# ç›´æ¥é‡å¯åç«¯æœåŠ¡
docker restart visitor-backend-blue
```

### é—®é¢˜5: æƒé™é—®é¢˜

```bash
# å¦‚æœé‡åˆ°æƒé™é—®é¢˜ï¼Œä½¿ç”¨rootæƒé™
docker exec --user root visitor-backend-blue sh -c "cd /app && npx prisma generate"
docker exec --user root visitor-backend-blue sh -c "cd /app && npx ts-node --esm prisma/seed.ts"
```

---

## ğŸ“Š éªŒè¯æˆåŠŸæ ‡å¿—

æ•°æ®åº“è¿ç§»æˆåŠŸåï¼Œåº”è¯¥çœ‹åˆ°ï¼š

1. âœ… åç«¯å®¹å™¨æ­£å¸¸è¿è¡Œ
   ```bash
   docker ps | grep visitor-backend-blue
   # åº”è¯¥æ˜¾ç¤º: Up X minutes
   ```

2. âœ… å¥åº·æ£€æŸ¥é€šè¿‡
   ```bash
   curl http://localhost:3001/api/health
   # è¿”å›: {"status":"ok"}
   ```

3. âœ… æ•°æ®åº“è¡¨å·²åˆ›å»º
   ```bash
   docker exec visitor-postgres psql -U postgres -d visitor_system -c "\dt"
   # åº”è¯¥çœ‹åˆ°æ‰€æœ‰è¡¨
   ```

4. âœ… æœ‰æµ‹è¯•ç”¨æˆ·æ•°æ®
   ```bash
   docker exec visitor-postgres psql -U postgres -d visitor_system -c "SELECT username, role FROM users;"
   # åº”è¯¥çœ‹åˆ° admin, bjadmin, guard001 ç­‰ç”¨æˆ·
   ```

---

## ğŸ¯ ä½¿ç”¨é»˜è®¤è´¦å·ç™»å½•

è¿ç§»æˆåŠŸåï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è´¦å·ç™»å½•ç³»ç»Ÿï¼š

| è§’è‰² | ç”¨æˆ·å | å¯†ç  | è¯´æ˜ |
|------|--------|------|------|
| ç®¡ç†å‘˜ | `admin` | `admin123` | ç³»ç»Ÿç®¡ç†å‘˜ |
| åˆ†åˆ¤å•† | `bjadmin` | `dist123` | åŒ—äº¬å»ºç­‘å…¬å¸ |
| åˆ†åˆ¤å•† | `shadmin` | `dist123` | ä¸Šæµ·å·¥ç¨‹é›†å›¢ |
| åˆ†åˆ¤å•† | `gzadmin` | `dist123` | å¹¿å·å»ºè®¾æœ‰é™å…¬å¸ |
| é—¨å« | `guard001` | `guard123` | å¼ ä¿å®‰ |
| é—¨å« | `guard002` | `guard123` | æé—¨å« |
| é—¨å« | `guard003` | `guard123` | ç‹è­¦å« |

è®¿é—®åœ°å€ï¼š`http://æœåŠ¡å™¨IP` æˆ– `http://æœåŠ¡å™¨IP:8086`

---

## ğŸ”„ å®Œæ•´æ‰§è¡Œå‘½ä»¤æ€»ç»“

```bash
# ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰æ­¥éª¤
./migrate-database.sh

# å¦‚æœè„šæœ¬å¤±è´¥ï¼Œæ‰‹åŠ¨æ‰§è¡Œï¼š
docker exec visitor-backend-blue sh -c "cd /app && npx prisma migrate deploy"
docker exec --user root visitor-backend-blue sh -c "cd /app && npx prisma generate"
docker exec visitor-backend-blue sh -c "cd /app && npx ts-node --esm prisma/seed.ts"
docker restart visitor-backend-blue

# éªŒè¯
docker ps | grep visitor
curl http://localhost:3001/api/health
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. âš ï¸ **æ•°æ®å®‰å…¨**: è¿ç§»å‰å»ºè®®å¤‡ä»½æ•°æ®åº“
   ```bash
   docker exec visitor-postgres pg_dump -U postgres visitor_system > backup_$(date +%Y%m%d).sql
   ```

2. âš ï¸ **ç½‘ç»œé…ç½®**: ç¡®ä¿å®¹å™¨åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­
   ```bash
   docker network inspect visitorsystem-network
   ```

3. âš ï¸ **ç¯å¢ƒå˜é‡**: æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®æ˜¯å¦æ­£ç¡®
   ```bash
   docker exec visitor-backend-blue env | grep DATABASE_URL
   docker exec visitor-backend-blue env | grep REDIS_URL
   ```

4. âš ï¸ **ç«¯å£å†²çª**: ç¡®ä¿ç«¯å£æœªè¢«å ç”¨
   ```bash
   netstat -tulpn | grep :3001
   netstat -tulpn | grep :5432
   ```

---

**è¿ç§»æˆåŠŸåï¼Œåç«¯æœåŠ¡åº”è¯¥ä¼šè‡ªåŠ¨å¯åŠ¨ï¼ğŸ‰**

