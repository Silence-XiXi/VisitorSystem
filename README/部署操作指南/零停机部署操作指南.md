# 🚀 访客管理系统 - 零停机蓝绿部署操作指南

## 📋 前提条件

- ✅ 蓝环境已在 Linux 服务器上运行
- ✅ 新代码已推送到服务器
- ✅ Docker 和 Docker Compose 已安装

---

## 🎯 完整零停机部署步骤

### 步骤 1: 登录服务器并进入项目目录

```bash
# SSH 登录到服务器
ssh user@your-server-ip

# 进入项目目录
cd /path/to/VisitorSystem
```

### 步骤 2: 拉取最新代码

```bash
# 拉取最新代码
git pull origin main

# 或者如果代码已经上传，跳过此步骤
```

### 步骤 3: 给脚本添加执行权限（首次需要）

```bash
# 添加执行权限
chmod +x switch-nginx-env.sh
chmod +x deploy.sh
```

### 步骤 4: 查看当前环境状态

```bash
# 查看当前运行状态
./switch-nginx-env.sh status
```

**预期输出示例：**
```
系统状态检查:

✓ Nginx 容器: Up 2 hours

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📍 当前环境: 蓝环境 (BLUE)
   前端: visitor-frontend-blue:3002
   后端: visitor-backend-blue:3001

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔵 蓝环境容器状态:
   ✓ visitor-backend-blue: Up 2 hours
   ✓ visitor-frontend-blue: Up 2 hours

🟢 绿环境容器状态:
   ✗ visitor-backend-green: 未运行
   ✗ visitor-frontend-green: 未运行
```

### 步骤 5: 部署绿环境（保持蓝环境运行）

```bash
# 🔥 关键：只启动绿环境，不停止蓝环境
docker-compose -f docker-compose.base.yml -f docker-compose.green.yml up -d --build

# 或者使用 docker compose (v2 命令)
docker compose -f docker-compose.base.yml -f docker-compose.green.yml up -d --build
```

**预期输出：**
```
visitor-postgres is up-to-date
visitor-redis is up-to-date
Building backend-green
...
Creating visitor-backend-green  ... done
Creating visitor-frontend-green ... done
```

### 步骤 6: 监控绿环境启动过程

```bash
# 查看绿环境后端日志
docker logs -f visitor-backend-green

# 按 Ctrl+C 退出日志查看

# 查看绿环境前端日志
docker logs -f visitor-frontend-green
```

**等待看到以下日志表示启动成功：**
- 后端：`Application is running on port 3001`
- 前端：`Listening on http://0.0.0.0:3002`

### 步骤 7: 验证两环境同时运行

```bash
# 查看所有容器状态
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

**应该看到：**
```
NAMES                      STATUS          PORTS
visitor-backend-blue       Up 2 hours      0.0.0.0:3001->3001/tcp
visitor-frontend-blue      Up 2 hours      0.0.0.0:3002->3002/tcp
visitor-backend-green      Up 1 minute     0.0.0.0:3003->3001/tcp
visitor-frontend-green     Up 1 minute     0.0.0.0:3004->3002/tcp
visitor-nginx              Up 2 hours      0.0.0.0:8086->80/tcp
visitor-postgres           Up 2 hours      0.0.0.0:5432->5432/tcp
visitor-redis              Up 2 hours      0.0.0.0:6379->6379/tcp
```

### 步骤 8: 测试绿环境功能

```bash
# 测试绿环境后端健康检查
curl http://localhost:3003/api/health

# 预期输出: {"status":"ok"} 或类似信息

# 测试绿环境前端（在浏览器中访问）
# http://服务器IP:3004

# 🔍 重点测试新增或修改的功能
```

### 步骤 9: 查看当前 Nginx 配置状态

```bash
# 查看当前 Nginx 指向哪个环境
./switch-nginx-env.sh status
```

### 步骤 10: 切换流量到绿环境（零停机切换）⚡

```bash
# 执行零停机切换
./switch-nginx-env.sh green
```

**预期输出：**
```
[INFO] Docker Nginx容器运行正常
[INFO] 切换到绿环境...
[INFO] 已备份当前配置
[INFO] 已更新配置文件指向绿环境
[INFO] 重新加载 Nginx 配置...
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
[SUCCESS] ✅ 已切换到绿环境 (前端: visitor-frontend-green:3002, 后端: visitor-backend-green:3001)

系统状态检查:

✓ Nginx 容器: Up 2 hours

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📍 当前环境: 绿环境 (GREEN)
   前端: visitor-frontend-green:3002
   后端: visitor-backend-green:3001
```

### 步骤 11: 验证切换成功

```bash
# 在浏览器中访问正常地址（通过 Nginx）
# http://服务器IP:8086

# 查看绿环境访问日志
docker logs visitor-backend-green --tail 30

# 应该看到新的访问请求日志
```

### 步骤 12: 观察期（保持蓝环境运行 30 分钟）

```bash
# 🎯 建议保持蓝环境运行 30 分钟观察
# 监控绿环境日志，确保无异常

# 实时查看日志
docker logs -f visitor-backend-green

# 查看系统资源使用
docker stats
```

### 步骤 13: 停止蓝环境（确认稳定后）

```bash
# ⏰ 确认绿环境稳定运行后（30分钟-1小时）
# 停止蓝环境释放资源

docker-compose -f docker-compose.blue.yml down

# 注意：镜像仍保留，可快速重启用于回滚
```

---

## 🔄 紧急回滚步骤

如果发现绿环境有问题，需要立即回滚：

### 方式 1: 快速切换回蓝环境（蓝环境仍在运行）

```bash
# 1️⃣ 瞬间切换 Nginx 回蓝环境（<100ms）
./switch-nginx-env.sh blue

# 2️⃣ 验证回滚成功
./switch-nginx-env.sh status

# 3️⃣ 停止有问题的绿环境
docker-compose -f docker-compose.green.yml down
```

### 方式 2: 重启蓝环境（如果已停止）

```bash
# 1️⃣ 快速重启蓝环境
docker-compose -f docker-compose.base.yml -f docker-compose.blue.yml up -d

# 2️⃣ 等待启动（约30秒）
sleep 30

# 3️⃣ 切换 Nginx 回蓝环境
./switch-nginx-env.sh blue

# 4️⃣ 停止绿环境
docker-compose -f docker-compose.green.yml down
```

---

## 📊 零停机时间线

```
时间 | 操作                           | 用户体验
-----|--------------------------------|----------
0分  | 🔵 蓝环境运行中                 | ✅ 正常访问
2分  | 🟢 开始构建绿环境               | ✅ 正常访问（蓝环境服务）
5分  | 🟢 绿环境启动完成               | ✅ 正常访问（蓝环境服务）
10分 | 🔍 测试绿环境                   | ✅ 正常访问（蓝环境服务）
15分 | ⚡ 切换 Nginx 到绿环境         | ⏸️ <100ms 延迟
15分 | 🟢 流量已切换到绿环境           | ✅ 正常访问（绿环境服务）
45分 | 📊 监控绿环境稳定性             | ✅ 正常访问（绿环境服务）
60分 | 🛑 停止蓝环境（可选）           | ✅ 正常访问（绿环境服务）
```

**总停机时间：< 100 毫秒**

---

## 🎯 常用命令速查表

| 命令 | 说明 |
|------|------|
| `./switch-nginx-env.sh status` | 查看当前环境和容器状态 |
| `./switch-nginx-env.sh green` | 切换到绿环境 |
| `./switch-nginx-env.sh blue` | 切换到蓝环境 |
| `docker ps` | 查看运行中的容器 |
| `docker logs -f 容器名` | 实时查看容器日志 |
| `docker stats` | 查看容器资源使用 |
| `docker-compose -f docker-compose.green.yml down` | 停止绿环境 |
| `docker-compose -f docker-compose.blue.yml down` | 停止蓝环境 |

---

## ⚠️ 重要注意事项

1. **不要使用 `./deploy.sh green`**
   - ❌ 这个命令会先停止蓝环境，导致停机
   - ✅ 使用 `docker-compose -f ...` 手动命令

2. **共享数据库**
   - 蓝绿环境共享同一个数据库
   - 数据库迁移需要向后兼容
   - 避免破坏性的 schema 变更

3. **环境变量**
   - 确保 `.env` 文件配置正确
   - 两环境使用相同的环境变量

4. **健康检查**
   - 切换前充分测试绿环境
   - 确认新功能正常工作
   - 检查错误日志

5. **保持蓝环境待命**
   - 切换后至少保持 30 分钟
   - 方便快速回滚
   - 确认稳定后再停止

---

## 🐛 故障排查

### 问题 1: 绿环境启动失败

```bash
# 查看详细错误日志
docker logs visitor-backend-green
docker logs visitor-frontend-green

# 常见原因：
# - 端口冲突（3003/3004 被占用）
# - 数据库连接失败
# - 环境变量配置错误
```

### 问题 2: Nginx 切换失败

```bash
# 查看 Nginx 日志
docker logs visitor-nginx

# 手动测试配置
docker exec visitor-nginx nginx -t

# 查看配置文件内容
cat docker/nginx/nginx.conf
```

### 问题 3: 容器无法访问

```bash
# 检查网络连接
docker network inspect visitorsystem-network

# 检查容器是否在同一网络
docker ps --format "{{.Names}}\t{{.Networks}}"

# 重启网络
docker network rm visitorsystem-network
docker network create visitorsystem-network
```

---

## 📞 技术支持

如有问题，请检查以下日志：
- Nginx: `docker logs visitor-nginx`
- 后端: `docker logs visitor-backend-green`
- 前端: `docker logs visitor-frontend-green`
- 数据库: `docker logs visitor-postgres`

---

**祝您部署顺利！🎉**

