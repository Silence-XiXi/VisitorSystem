# 未归还物品显示功能实现
# UNRETURNED_ITEMS_FEATURE

## 功能描述

在Guard.tsx页面的今日访客记录报表中，将工人未归还物品的信息关联到现有的"借用物品"列中。当某工人昨天入场借了2件物品，离场时只归还了1件，第二天入场后的访客记录会在"借用物品"列中显示那1件未归还的物品。

## 实现内容

### 1. 数据获取逻辑优化

**修改了 `enrichVisitorRecord` 函数**：
- 原来只显示当前访客记录关联的借用记录
- 现在同时获取该工人所有未归还的物品记录（包括之前访客记录的）
- 将总未归还物品数量赋值给 `borrowedItems` 字段

**修改了 `loadVisitorRecords` 函数**：
- 为每个工人单独获取所有未归还的物品记录
- 使用 `worker_${workerId}` 作为key存储工人的所有借用记录
- 使用 `visitor_${visitorRecordId}` 作为key存储当前访客记录的借用记录

### 2. UI界面更新

**优化了"借用物品"列**：
- 列标题：`借用物品`（保持原有名称）
- 现在显示该工人所有未归还的物品数量（包括之前访客记录的）
- 添加了工具提示说明功能用途
- 添加了问号图标提示用户这是未归还物品数量

**颜色编码**：
- 绿色：无未归还物品（0件）
- 红色：有未归还物品（>0件），显示警告样式

### 3. 翻译文本

在 `zh-CN.ts` 中添加了新的翻译键：
- `unreturnedItemsTooltip`: "显示该工人所有未归还的物品数量"
- `includesPreviousRecords`: "包括之前访客记录的未归还物品"

## 技术实现细节

### 数据结构

```typescript
// 访客记录现在包含以下字段：
{
  ...record,
  borrowedItems: number,      // 该工人所有未归还物品数量（修改为显示未归还物品）
  returnedItems: number,      // 当前访客记录的已归还物品数量
  unreturnedItems: number     // 该工人所有未归还物品数量（保留用于其他用途）
}
```

### API调用

```typescript
// 获取工人所有未归还物品记录
const allWorkerBorrowRecords = await apiService.getWorkerBorrowRecords(workerId);

// 获取当前访客记录的借用记录
const visitorBorrowRecords = await apiService.getWorkerBorrowRecords(workerId, visitorRecordId);
```

### 数据映射

```typescript
// 使用Map存储不同维度的借用记录
const borrowRecordsMap = new Map();

// 工人维度：存储该工人所有借用记录
borrowRecordsMap.set(`worker_${workerId}`, allWorkerBorrowRecords);

// 访客记录维度：存储当前访客记录的借用记录
borrowRecordsMap.set(`visitor_${visitorRecordId}`, visitorBorrowRecords);
```

## 使用场景

1. **门卫查看今日访客记录**：可以快速识别哪些工人有未归还的物品
2. **物品管理**：帮助门卫跟踪物品借用状态，避免物品丢失
3. **历史记录关联**：即使工人多次入场，也能看到之前未归还的物品
4. **详细查看功能**：
   - 点击"借用物品"列：查看该工人今日相关物品记录（今日借出+未归还+今日归还）
   - 点击"已归还"列：查看该工人所有今日归还的物品记录

## 注意事项

- "借用物品"列现在显示的是该工人今日相关物品的总数量，包括：借用日期是今日的 + 当前所有未归还的 + 归还时间是今日的（去重后）
- "已归还"列现在显示的是该工人所有今日归还的物品数量，而不是当前访客记录的已归还数量
- 点击借用物品数量可以查看该工人今日相关物品的详细记录（包括今日借出、未归还、今日归还的所有物品）
- 点击已归还数量可以查看该工人所有今日归还物品的详细记录
- 弹窗标题会根据查看的内容类型动态显示："今日相关物品记录（今日借出+未归还+今日归还）"或"今日归还物品记录"
- 工具提示会显示相应的说明：借用物品列显示"今日相关 X 件物品（今日借出+未归还+今日归还）"，已归还列显示"今日归还 X 件物品"

## 文件修改清单

1. `visitorSystem-frontend/src/pages/Guard.tsx` - 主要功能实现
2. `visitorSystem-frontend/src/locales/zh-CN.ts` - 翻译文本添加

## 测试建议

1. 创建测试数据：工人A昨天借了2件物品，只归还了1件
2. 今天工人A再次入场
3. 在今日访客记录中查看，应该显示1件未归还物品
4. 验证颜色编码和工具提示是否正常工作
