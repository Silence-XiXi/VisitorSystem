# 借用时长计算功能实现说明

## 需求描述
在门卫操作页面（Guard.tsx）的归还物品功能中，实现借用时长的自动计算和保存。系统需要根据借用日期时间和归还日期时间计算总借用分钟数，并保存到数据库中。

## 修改内容

### 后端修改

**文件：** `visitorSystem-backend/src/guards/guards.service.ts`

**修改位置：** `returnItem` 方法（第604-669行）

**主要改动：**

1. **添加借用时长计算逻辑**（第638-651行）：
   ```typescript
   // 计算借用时长（分钟）
   // 将借用日期和时间组合成完整的 DateTime
   const borrowDateTime = new Date(record.borrowDate);
   const [borrowHour, borrowMinute, borrowSecond] = record.borrowTime.split(':').map(Number);
   borrowDateTime.setHours(borrowHour, borrowMinute, borrowSecond || 0, 0);
   
   // 将归还日期和时间组合成完整的 DateTime
   const returnDateTime = new Date(returnDate);
   const [returnHour, returnMinute, returnSecond] = returnTime.split(':').map(Number);
   returnDateTime.setHours(returnHour, returnMinute, returnSecond || 0, 0);
   
   // 计算时间差（毫秒），然后转换为分钟
   const borrowDurationMs = returnDateTime.getTime() - borrowDateTime.getTime();
   const borrowDurationMinutes = Math.round(borrowDurationMs / (1000 * 60)); // 四舍五入到最接近的分钟
   ```

2. **更新数据库记录时保存借用时长**（第660行）：
   ```typescript
   borrowDuration: borrowDurationMinutes
   ```

**计算逻辑说明：**
- 从数据库记录中获取 `borrowDate` 和 `borrowTime`，组合成完整的借用日期时间
- 使用当前归还的 `returnDate` 和 `returnTime`，组合成完整的归还日期时间
- 计算两个时间点之间的毫秒差值
- 将毫秒差值转换为分钟数，四舍五入到最接近的整数
- 将计算结果保存到 `borrowDuration` 字段

### 前端修改

**文件：** `visitorSystem-frontend/src/pages/Guard.tsx`

**主要改动：**

1. **更新接口定义**（第146-155行）：
   ```typescript
   const [itemBorrowRecords, setItemBorrowRecords] = useState<Array<{
     id: string
     itemName: string
     itemId: string
     borrowTime: string
     returnTime: string | null
     borrowDuration: number | null  // 新增字段
     status: string
     remark?: string
   }>>([])
   ```

2. **添加时长格式化函数**（第2144-2157行）：
   ```typescript
   const formatBorrowDuration = (minutes: number | null): string => {
     if (minutes === null || minutes === undefined) return '-'
     
     const hours = Math.floor(minutes / 60)
     const mins = minutes % 60
     
     if (hours > 0 && mins > 0) {
       return `${hours}小时${mins}分钟`
     } else if (hours > 0) {
       return `${hours}小时`
     } else {
       return `${mins}分钟`
     }
   }
   ```

3. **更新数据格式化**（第1746行和第1795行）：
   在两个数据格式化函数中添加了 `borrowDuration` 字段的提取：
   ```typescript
   borrowDuration: item.borrowDuration || null
   ```

4. **添加表格列显示**（第2184-2189行）：
   ```typescript
   {
     title: '借用时长',
     dataIndex: 'borrowDuration',
     key: 'borrowDuration',
     render: (minutes: number | null) => formatBorrowDuration(minutes),
   }
   ```

**显示效果：**
- 如果借用时长少于1小时：显示"X分钟"
- 如果借用时长超过1小时但没有余数：显示"X小时"
- 如果借用时长超过1小时且有余数：显示"X小时Y分钟"
- 如果没有数据：显示"-"

## 数据库字段

**表名：** `item_borrow_records`

**相关字段：**
- `borrowDate` (DateTime): 借用日期
- `borrowTime` (String): 借用时间（格式：HH:mm:ss）
- `returnDate` (DateTime?): 归还日期（可选）
- `returnTime` (String?): 归还时间（格式：HH:mm:ss）（可选）
- `borrowDuration` (Int?): 借用时长（分钟）（可选）

## 功能测试

### 测试场景

1. **当天归还测试**
   - 借用时间：2025-10-13 09:00:00
   - 归还时间：2025-10-13 11:30:00
   - 预期结果：borrowDuration = 150分钟（2小时30分钟）

2. **跨天归还测试**
   - 借用时间：2025-10-13 15:00:00
   - 归还时间：2025-10-14 09:00:00
   - 预期结果：borrowDuration = 1080分钟（18小时）

3. **短时间借用测试**
   - 借用时间：2025-10-13 10:00:00
   - 归还时间：2025-10-13 10:45:00
   - 预期结果：borrowDuration = 45分钟

### 测试步骤

1. 启动后端服务
2. 启动前端服务
3. 登录门卫账号
4. 为工人借用物品
5. 归还物品
6. 查看物品借用记录，确认借用时长显示正确

## API 接口

**归还物品接口**

- **URL:** `PUT /guards/borrow-records/:id/return`
- **权限:** GUARD
- **参数:** recordId（路径参数）
- **返回数据:** 包含 `borrowDuration` 字段的完整借用记录

## 注意事项

1. 借用时长的计算是在后端归还物品时自动完成的，前端不需要手动计算
2. 借用时长以分钟为单位存储在数据库中
3. 如果归还时间早于借用时间（理论上不应该发生），会得到负数
4. 前端显示时会自动将分钟数转换为更友好的"X小时Y分钟"格式
5. 只有在物品归还时才会计算和保存借用时长，未归还的物品该字段为 null

## 兼容性

- 此功能不影响现有的借用和归还流程
- 对于历史数据，borrowDuration 字段将为 null（因为当时归还时未计算）
- 从功能部署后开始，所有新的归还操作都会自动计算并保存借用时长

## 多语言支持

### 语言文件更新

**文件：** `visitorSystem-frontend/src/locales/zh-CN.ts` 和 `en-US.ts`

1. **通用时间单位**（common 部分）：
   ```typescript
   // 中文
   hour: '小时',
   hours: '小时',
   minute: '分钟',
   minutes: '分钟',
   
   // 英文
   hour: 'hour',
   hours: 'hours',
   minute: 'minute',
   minutes: 'minutes',
   ```

2. **表格列标题**（guard 部分）：
   ```typescript
   // 中文
   borrowDuration: '借用时长',
   
   // 英文
   borrowDuration: 'Borrow Duration',
   ```

### formatBorrowDuration 函数多语言实现

函数已更新为支持中英文切换：

```typescript
const formatBorrowDuration = (minutes: number | null): string => {
  if (minutes === null || minutes === undefined) return '-'
  
  const hours = Math.floor(minutes / 60)
  const mins = minutes % 60
  
  // 根据语言选择单复数形式（英文需要区分单复数）
  const hourUnit = locale === 'en-US' 
    ? (hours === 1 ? t('common.hour') : t('common.hours'))
    : t('common.hours')
  
  const minuteUnit = locale === 'en-US'
    ? (mins === 1 ? t('common.minute') : t('common.minutes'))
    : t('common.minutes')
  
  if (hours > 0 && mins > 0) {
    return `${hours} ${hourUnit} ${mins} ${minuteUnit}`
  } else if (hours > 0) {
    return `${hours} ${hourUnit}`
  } else {
    return `${mins} ${minuteUnit}`
  }
}
```

### 显示示例

**中文显示：**
- 90分钟 → "1 小时 30 分钟"
- 120分钟 → "2 小时"
- 45分钟 → "45 分钟"

**英文显示：**
- 90分钟 → "1 hour 30 minutes"
- 120分钟 → "2 hours"
- 45分钟 → "45 minutes"
- 1分钟 → "1 minute"（单数形式）

### 特性

1. **自动单复数处理**：英文会根据数量自动选择单数（hour/minute）或复数（hours/minutes）形式
2. **语言切换即时生效**：用户切换语言后，时长显示会立即更新
3. **一致性**：与系统其他部分的多语言实现保持一致

## Bug修复记录

### 问题描述
在 `ItemBorrowRecords.tsx` 页面中，`borrowDuration` 字段被错误地当作**小时**来显示，但后端实际返回的是**分钟数**。这导致：
- 1454分钟被显示为"1454小时"（错误）
- 正确应该显示为"24小时14分钟"

### 修复内容

**文件：** `visitorSystem-frontend/src/pages/ItemBorrowRecords.tsx`

1. **修正类型注释**（第26行）：
   ```typescript
   // 修改前
   borrowDuration?: number // 借用时长（小时）
   
   // 修改后
   borrowDuration?: number // 借用时长（分钟）
   ```

2. **添加格式化函数**（第124-154行）：
   - 添加了与 `Guard.tsx` 相同的 `formatBorrowDuration` 函数
   - 支持多语言显示
   - 支持英文单复数处理

3. **更新所有显示位置**：
   - **导出Excel**（第327行）：使用 `formatBorrowDuration(record.borrowDuration)` 替代 `` `${record.borrowDuration} Hours` ``
   - **表格列**（第468行）：使用 `formatBorrowDuration(duration)` 替代 `` `${duration}${t('itemBorrowRecords.hours')}` ``
   - **详情Modal**（第879行）：使用 `formatBorrowDuration(selectedRecord.borrowDuration)` 替代 `` {selectedRecord.borrowDuration}{t('itemBorrowRecords.hours')} ``

### 修复效果

| 原显示（错误） | 修复后（正确） |
|--------------|--------------|
| 1454小时 | 24小时14分钟 |
| 90小时 | 1小时30分钟 |
| 1小时 | 1分钟 |

### 验证测试

测试脚本验证了计算逻辑：
```javascript
1454分钟 => 24小时14分钟  ✓
90分钟 => 1小时30分钟  ✓
120分钟 => 2小时  ✓
45分钟 => 45分钟  ✓
```

## 归还时间智能显示功能

### 功能描述
在 `ItemBorrowRecords` 页面中，归还时间会根据借用日期和归还日期是否为同一天，智能选择显示格式：
- **同一天归还**：只显示时间（HH:mm:ss）
- **跨天归还**：显示日期+时间（YYYY-MM-DD HH:mm:ss）

### 实现细节

**文件：** `visitorSystem-frontend/src/pages/ItemBorrowRecords.tsx`

**新增函数** `formatReturnTime`（第156-172行）：
```typescript
const formatReturnTime = (record: ItemBorrowRecord): string => {
  // 如果没有归还时间，返回 -
  if (!record.returnDate || !record.returnTime) return '-'
  
  // 比较借用日期和归还日期
  const borrowDate = record.borrowDate
  const returnDate = record.returnDate
  
  // 如果是同一天，只显示时间
  if (borrowDate === returnDate) {
    return record.returnTime
  }
  
  // 如果不是同一天，显示日期+时间
  return `${returnDate} ${record.returnTime}`
}
```

### 应用位置

1. **表格列显示**（第461-471行）
2. **导出Excel功能**（第342行）
3. **详情Modal**（第883-886行）

### 显示效果示例

| 借用日期 | 归还日期 | 显示格式 | 示例 |
|---------|---------|---------|------|
| 2025-10-13 | 2025-10-13 | 只显示时间 | 14:30:00 |
| 2025-10-13 | 2025-10-14 | 日期+时间 | 2025-10-14 09:00:00 |
| 2025-10-13 | 2025-10-15 | 日期+时间 | 2025-10-15 16:45:00 |

### 优势

1. **节省空间**：同一天归还时不重复显示日期
2. **清晰明了**：跨天归还时完整显示日期，便于识别
3. **用户友好**：自动判断，无需手动设置
4. **一致性**：所有显示位置（表格、导出、详情）统一使用该逻辑

## 后续优化建议

1. 可以在管理员报表页面添加借用时长的统计分析
2. 可以设置物品借用时长的预警机制（例如超过24小时提醒）
3. 可以根据借用时长生成物品使用效率报告
4. 可以添加更多语言支持（如马来语、泰语等）

